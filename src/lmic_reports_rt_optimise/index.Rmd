---
title: ""
header-includes: \usepackage{caption}
date: ""
urlcolor: blue
output:
  html_document:
    keep_md: yes
    self_contained: yes
    css: styles.css
    theme: cosmo
    fig_caption: TRUE
    includes:
      in_header: ganalytics.txt
  pdf_document: 
    fig_caption: true
    toc: false
    includes: 
      in_header: header.tex
      after_body: footer.tex
  word_document:
    df_print: kable
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: tango
    reference_docx: template.docx
params:
   central: NA
   excess: FALSE
   df_excess: NA
   df_cases: NA
   date_0: NA
   country: NA
   surging: FALSE
   rt: NA
   variants: FALSE
   date_range: NA
   cases_milds: NA
---

```{r rm_title_page, echo=FALSE}
head <- cat('
\\AtBeginDocument{\\let\\maketitle\\relax}
', file = "header.tex")

```

```{r knitr_options, echo=FALSE} 
knitr::opts_chunk$set(message = FALSE,warning = FALSE)
options("dplyr.summarise.inform"=FALSE)
```


```{js, echo = FALSE}

if ($(window).width() < 768) {
$('.dropdown-menu a.dropdown-toggle').on('click', function(e) {
if (!$(this).next().hasClass('show')) {
$(this).parents('.dropdown-menu').first().find('.show').removeClass("show");
}



var $subMenu = $(this).next(".dropdown-menu");
if (!$subMenu.hasClass('show')) {
$subMenu.addClass('show');
$subMenu.show();
} else {
$subMenu.removeClass('show');
$subMenu.hide();
}



$(this).parents('li.nav-item.dropdown.show').on('hidden.bs.dropdown', function(e) {
$('.dropdown-submenu .show').removeClass("show");
});



return false;
});
}

```


```{r, echo = FALSE, message=FALSE, warning=FALSE}
date <- as.Date(date)

# grab inputs
excess <- params$excess
df_cases <- params$df_cases
df_excess <- params$df_excess
country <- params$country
date_0 <- params$date_0
surging <- params$surging
rt <- params$rt
cases_milds <- params$cases_milds
has_reported_case <- "new_detected_Mild" %in% names(cases_milds)
if(has_reported_case){
  proportion_detected <- base::format(signif(quantile(unique(cases_milds$p_detected), c(0.025, 0.5, 0.975)) * 100, 3),
                                      trim = TRUE, drop0trailing = TRUE)
  proportion_detected_txt <- paste0(
    "Assuming a uniform level of detection across all infections, our modelling estimates that ",
    proportion_detected[2], "% (", proportion_detected[1], ", ", proportion_detected[3], " 95% CrI) of infections are detected over the 3 month period before ", date, "."
  )
  
  projection_detected <- cases_milds %>% 
    rename(ddate = date) %>% 
    filter(projection & ddate <= date + 28) %>%
    group_by(replicate) %>% 
    summarise(
      detected_case = sum(new_detected_Case) + sum(new_detected_Mild)
    ) %>% 
    pull(detected_case) %>% 
    quantile(c(0.025, 0.5, 0.975)) %>% 
    signif(3) %>% 
    base::format(trim = TRUE, drop0trailing = TRUE)
  
  chance_of_detection <- cases_milds %>% 
    group_by(replicate) %>% 
    summarise(
      p_mild = p_mild[1],
      p_case = p_case[1],
      .groups = "drop"
    ) %>% 
    summarise(
      across(
        c(p_mild, p_case),
        ~quantile(.x * 100, c(0.025, 0.5, 0.975)) %>% 
          signif(3) %>% 
          base::format(trim = TRUE, drop0trailing = TRUE)
      )
    )
  print_cr <- function(m, l, h){
    paste0(m, " (", l, ", ", h, " 95% CrI)")
  }
  
  estimated_detected_txt <- paste0(
    "Looking at the last 3 months of reported COVID-19 infections we estimate that ", 
    print_cr(chance_of_detection$p_case[2], chance_of_detection$p_case[1], chance_of_detection$p_case[3]), 
    "% of hospitalised cases are detected and ",
    print_cr(chance_of_detection$p_mild[2], chance_of_detection$p_mild[1], chance_of_detection$p_mild[3]),
    "% of the mild for asymptomatic. With this we estimate that there will be ", 
    projection_detected[2], " (", projection_detected[1], ", ", projection_detected[3], " 95% CrI) new detected infections over the next 28 days."
  )
} else {
  proportion_detected_txt <- ""
  estimated_detected_txt <- ""
}
url <- paste0("https://github.com/mrc-ide/global-lmic-reports/raw/master/",iso3c,"/index.pdf")

format_type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
figRef <- function(caption) {
  if(format_type == "latex") {
    gsub("Figure \\d: ","",caption)
  } else {
    caption
  }
}

fig_height <- function(pdf = 4, html = 6) {
  if(format_type == "latex") {
    pdf
  } else {
    html
  }
}

fig_center <- function() {
  if(format_type == "latex") {
    "default"
  } else {
    "center"
  }
}

latex_omit <- function(text) {
  if(knitr::is_latex_output())
    return("")
  else
    return(text)
}

pagebreak <- function() {
  if(knitr::is_latex_output())
    return("\\newpage")
  else
    return('<div style="page-break-before: always;" />')
}

linebreak <- function() {
  if(knitr::is_latex_output())
    return("")
  else
    return('<br>')
}

pdf_line_break <- function() {
  if(knitr::is_latex_output())
    return("<br>")
  else
    return('')
}

if(excess & sum(df_excess$deaths) <= 10) {
  show_sentence <- paste("**N.B. ", country, 
                          " is not shown in the following plot as only ", 
                           sum(df_excess$deaths),
                          " deaths have been reported to date**")
} else if(!excess & sum(df_cases$deaths) <= 10) {
  show_sentence <- paste("**N.B. ", country, 
                          " is not shown in the following plot as only ", 
                           sum(df_cases$deaths),
                          " deaths have been reported to date**")
} else {
  show_sentence <-  ""
}

if(any(df_cases$cases < 0)) {
  show_cases_sentence <- paste("**N.B. ", country, 
                               " has revised their historic reported cases and", 
                               " thus have reported negative cases.**")
} else  {
  show_cases_sentence <- ""
}


```

```{r ecdc prep, echo = FALSE, collapse=TRUE, warning=FALSE, message=FALSE}

## Summaries
form <- function(x) {
  paste0(base::format(round(x[[1]]), big.mark=","),
         " (95% CI: ", base::format(round(x[[2]]), big.mark=","),
         "-", base::format(round(x[[3]]), big.mark=","),")")
}

form_round_dig <- function(x, dig = 2) {
  paste0(base::format(round(x[[1]], dig), big.mark=","),
         " (95% CI: ", base::format(round(x[[2]], dig), big.mark=","),
         "-", base::format(round(x[[3]], dig), big.mark=","),")")
}

t_test_safe <- function(x, ...) {
  out <- try(t.test(x, ...), silent = TRUE)
  if (inherits(out, "try-error"))
  {
    out <- list("conf.int"=c(mean(x),mean(x)))
  }
  return(out)
}


## -----------------------------------------------------------------------------
## totals unmitigated
## -----------------------------------------------------------------------------
time_period <- 28
past_dates <- seq(date - time_period, date, by = 1)[-1]
projection_end_date <- date + time_period

infections <- params$central %>% 
  filter(compartment == "infections")
infections_28 <- infections %>% 
  filter(date %in% past_dates)

infs <- group_by(infections_28, replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(inf_tot = mean(tot, na.rm = TRUE), 
            inf_min = t_test_safe(tot)$conf.int[1],
            inf_max = t_test_safe(tot)$conf.int[2])

infs_today <- group_by(infections[infections$date == date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

infs_28 <- group_by(infections[infections$date==projection_end_date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

hospital <- params$central %>% 
  filter(compartment == "hospital_demand")

hosp_today <- group_by(hospital[hospital$date == date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

hosp_28 <- group_by(hospital[hospital$date==projection_end_date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

icu <- params$central %>% 
  filter(compartment == "ICU_demand")
icu_today <- group_by(icu[icu$date == date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

icu_28 <- group_by(icu[icu$date==projection_end_date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

deaths <- params$central %>% 
  filter(compartment == "deaths")
deaths_28 <- group_by(deaths[deaths$date==projection_end_date,], replicate) %>% 
  summarise(tot = sum(y, na.rm = TRUE)) %>% 
  summarise(i_tot = mean(tot, na.rm = TRUE), 
            i_min = t_test_safe(tot)$conf.int[1],
            i_max = t_test_safe(tot)$conf.int[2])

summary_number_df <- data.frame(variable = c("est_infections","report_infections",
                                             "report_deaths", "hospital_28", "icu_28"),
                                value = c(infs[[1]], sum(df_cases$cases), sum(data$deaths),
                                          hosp_28[[1]], icu_28[[1]]),
                                country = country,
                                continent = countrycode::countrycode(country, origin = 'country.name', destination = 'continent'))
saveRDS(summary_number_df, "summary_df.rds")

```

```{r capacity warn, echo = FALSE, collapse=TRUE, warning=FALSE}
if (surging) {
  show_capacity_sentence <- paste(
    "**N.B.", country,
    "is forecast to be close to or surpassing our best estimates for healthcare",
    "capacity in the next 28 days.** Estimates of deaths in the next 28 days may be", 
    "inaccurate due to our working assumptions for mortality in individuals who", 
    "do not receive appropriate treatment. [See our methods for more", 
    "information.](https://mrc-ide.github.io/global-lmic-reports/parameters.html)")
  fig_cap_capacity <- paste(
    "The forecasted deaths in blue assumes healthcare capacity has been surged",
    "to ensure sufficient supply of ICU and hospital beds. The red curve assumes",
    "no surging in healthcare capacity and subsequently projects increased deaths.")
} else  {
  show_capacity_sentence <-  paste("")
  fig_cap_capacity <- ""
}
```

```{r other sources, echo = FALSE, collapse = TRUE, warning = FALSE}

if (iso3c == "BRA") {
  other_sources <- paste("**For sub-national estimates of $R_t$, and further analysis of",
                         "Brazil, please see ",
                         "[Report 21](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-21-brazil/)**")
} else if (iso3c == "SYR") {
  other_sources <- paste("**We are aware of under-reporting of deaths in Damascus, Syria. This is not represented in this",
                         "report, but please see ",
                         "[Report 31](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-31-syria/)**")
} else if (iso3c == "SDN") {
  other_sources <- paste("**We are aware of under-reporting of deaths in Khartoum, Sudan. This is not represented in this",
                         "report, but please see ",
                         "[Report 39](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-39-sudan/)**")
} else {
  other_sources <- ""
}

```

## Situation Report for COVID-19: `r country`, `r base::format(date, "%Y-%m-%d")`

`r latex_omit("---")`

#### **[Download the report for `r country`, `r base::format(date, "%Y-%m-%d")` here](`r url`).**


This report uses excess mortality data for the period of the COVID-19 epidemic (December 2019 onwards).
These numbers are calculated by comparing current mortality to historic trends.
These data are then used to back-calculate an ‘inferred number of COVID-19 infections’ using mathematical modelling techniques (see [Methods](https://mrc-ide.github.io/global-lmic-reports/parameters.html) for further details) to estimate the number of people that have been infected and to make short-term projections for future healthcare needs.
Not all countries are able to provide timely estimates of excess mortality, so estimates from the [The Economist Excess Deaths Model](https://github.com/TheEconomist/covid-19-the-economist-global-excess-deaths-model) are harnessed to fill in these gaps.
Data on reported deaths and cases are from the COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University.
These are updated daily and whilst there may be a short delay, they are generally consistent with Ministry reports.

<br> 

### Epidemiological Situation

| **Total Reported Cases** | **Total Reported Deaths** | **Total Estimated Excess Mortality** | **Estimated $R_{eff}$** |
| --- | --- | ---- | --- |
| `r base::format(sum(df_cases$cases), big.mark=",")` | `r base::format(sum(df_cases$deaths), big.mark=",")`|`r base::format(sum(df_excess$deaths), big.mark=",")`| `r form_round_dig(rt$rts[nrow(rt$rts),c("Reff", "Reff_min", "Reff_max")])` |

### Dominant Variants of Concern

```{r set up delta, echo = FALSE, collapse = TRUE, warning = FALSE, fig.cap=figRef("**Figure 0: Timings of the modelled variants.**"), fig.height=fig_height(1,1), fig.width=fig_height(8,8), fig.align=fig_center()}
if(identical(params$adjust_delta, FALSE)){
  delta_text <- ""
} else {
  delta_text <- paste0(
    "This report adjusts for the ", paste0(variant_timings$variant, collapse = ", "), " variants. The timings of which are shown in Figure 1. These dates are based upon reported sequencing data from NextStrain and GISAID. For countries with a limited number of recent sequences, these dates are inferred from global or regional trends and should be interpreted with caution."
  )
  suppressWarnings(suppressMessages(print(variant_timings_index_plot(variant_timings, date_range))))
}
```

`r delta_text`

`r pdf_line_break()`

The figure below shows the cumulative reported deaths as a function of the time since the 10th death was reported. Dashed lines show the expected trajectory for different doubling times of the epidemic. For example, with a doubling time of 3 days, if there are currently a total of 20 deaths reported, we would expect there to be 40 deaths in total reported in 3 days-time, 80 deaths in 6 days-time, 160 deaths in 9 days-time etc. For most epidemics, in the absence of interventions, we expect a doubling time of 3-4 days for this disease. `r show_sentence`

<br>

```{r fig1, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE, fig.cap=figRef("**Figure 1: Cumulative Deaths since 10 deaths.** Country not shown if fewer than 10 deaths."), fig.height=fig_height(4.25,6), fig.width=fig_height(8,8), fig.align=fig_center()}

suppressWarnings(suppressMessages(print(cumulative_deaths_plot(country = country, excess = excess))))

```

\newpage

<br>

### COVID-19 Transmission Modelling

The figure below shows the estimated number of people infected over the past 4 weeks.
The bar charts show, for comparison, the number of reported cases.
We estimate that there has been a total of `r form(infs)` infections over the past 4 weeks.
The right-hand plot shows these data on a different scale as the estimated infections are likely to be much larger than the reported cases.  **Importantly**, the estimated infections includes both asymptomatic and mild cases that would not necessarily be identified through surveillance.
Consequently, the estimated infections are likely to be significantly higher than the reported cases in all countries (see our [FAQ](https://mrc-ide.github.io/global-lmic-reports/FAQ.html#why-are-the-estimated-infections-so-much-higher-than-the-reported-cases) for further explanation of these differences and why the reported cases and estimated infections are unlikely to match).
`r show_cases_sentence` `r proportion_detected_txt`

<br>

```{r case plot, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE,  fig.cap=figRef("**Figure 2: Daily number of infections estimated by fitting to the current total of deaths.** Reported cases are shown in red. Model estimated infections are shown in blue (dark blue 50% interquartile range, light blue 95% quantile). The dashed line shows the current day."), fig.width=10, fig.height=fig_height(5.5,5.5), fig.align=fig_center()}

suppressWarnings(suppressMessages(print(cases_plot(params$central, data = df_cases, date = date, date_0 = date_0))))

```

`r pagebreak()`

By fitting to the time series of deaths, we are able to estimate a time-varying reproduction number, $R_{eff}$. $R_{eff}$ is the the average number of secondary infections caused by a single infected person at a given time.
If $R_{eff}$ is above 1, the rate of transmission is increasing and the number of new infections is increasing.
$R_{eff}$ is assumed to change proportionally to mobility.
By fitting our model to excess mortality we aim to account for under-ascertainment of COVID-19 related deaths (please see our [FAQ](https://mrc-ide.github.io/global-lmic-reports/FAQ.html#how-have-you-accounted-for-unreported-deaths) section for more information about this approach).

<br>

`r other_sources`

<br>

```{r fig0, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE, fig.cap=figRef("**Figure 3: Time-varying effective reproduction number, $R_{eff}$.** $R_{eff}$ (**green**) is the average number of secondary infections caused by a single infected person at time equal to $t$. A horizonatal dashed line is shown at $R_{eff}$ = 1. $R_{eff}$ < 1 indicates a slowing epidemic in which new infections are not increasing. $R_{eff}$ > 1 indicates a growing epidemic in which new infections are increasing over time. Dark green shows the 50% CI and light green shows the 95% CI"), fig.height=fig_height(3.5,5), fig.width=fig_height(6,10), fig.align=fig_center()}

suppressWarnings(suppressMessages(print(rt$plot)))

```

<br>

`r pagebreak()`

Using the model fit, we can forecast the expected trajectory for cumulative deaths assuming the transmission level, represented by the final $R_{t}$ value stays the same over the next 28 days. `r show_capacity_sentence`

<br>

```{r death forecast plots, echo = FALSE, collapse=TRUE, warning=FALSE, message=FALSE, fig.cap=figRef(paste0("**Figure 4: Estimated daily deaths.** Projected deaths assuming the current level of interventions are maintained are shown in red (median and 95% quantile). Excess mortality is plotted in black. Includes a forecast of the next 28 days.")), fig.width=if (surging) 10 else 8, fig.height=if (surging) 8 else 6, fig.align=fig_center()}

suppressWarnings(suppressMessages(
    deaths_plot(proj = params$central, proj_surge = NULL,
                             forecast = 28, 
                       df_cases = df_cases, df_excess = df_excess %>% 
                  mutate(deaths = deaths/as.numeric(date_end - date_start)), date_0 = date_0, date = date)))


```

<br>

`r pagebreak()`

### Short-term Epidemic Scenario

**The following scenario does not account for future VoC and assumes the current VoC (based on sequence data) remains dominant.**

We include a short-term projections of healthcare demand, new infections, and detected infections given that the $R_t$ number does not change.

We estimate that over the next 4 weeks demand for hospital beds will change from `r form(hosp_today)` patients requiring treatment with high-pressure oxygen at the current date to `r form(hosp_28)` hospital beds being required on `r base::format(date + 28, "%Y-%m-%d")` if no further interventions are introduced (Scenario 1).
Similarly, we estimate that over the next 4 weeks demand for critical care (ICU) beds will change from `r form(icu_today)` patients requiring treatment with mechanical ventilation at the current date to `r form(icu_28)` by `r base::format(date + 28, "%Y-%m-%d")`.
These projections are dependant on the chosen age-dependant hospitalisation rates (see [Methods](https://mrc-ide.github.io/global-lmic-reports/parameters.html)).
**N.B. This scenario is unlikely to show significant differences for the first week since there is a delay of approximately 10 days between infection and hospital admission. Consequently, the effectiveness of a change in policy is likely to be better captured by hospital admission data approximately 2 weeks after the policy change is implemented.**

The impact of each scenario has a more immediate effect on the daily number of infections. The figure below shows the impact of each scenario on the estimated daily incidence of new infections. We estimate that if the underlying $R_t$ of the virus remains the same the daily number of infections will change from `r form(infs_today)` at the current date to `r form(infs_28)` by `r base::format(date + 28, "%Y-%m-%d")`. `r estimated_detected_txt`

<br>

```{r healthcare plots, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE, fig.cap=figRef("**Figure 5: Scenario projection for the next 28 days.** Individuals needing an ICU bed are assumed to need mechanical ventilation. **"), fig.width=fig_height(8,10), fig.height=fig_height(8,10), fig.align=fig_center()}

vars_to_plot <- c("infections", "hospital_demand", "ICU_demand")
if(has_reported_case){
  vars_to_plot <- c(vars_to_plot, "new_detected_Infections")
  cases_milds <- cases_milds %>% 
    mutate(
      new_detected_Infections = new_detected_Mild + new_detected_Case
    )
}
plotting_df <- cases_milds %>% 
  left_join(
    params$central %>% 
      filter(compartment %in% c("infections", "hospital_demand", "ICU_demand")) %>% 
      select(replicate, date, compartment, y) %>% 
      pivot_wider(names_from = compartment, values_from = y),
    by = c("replicate", "date")
  ) %>% 
  group_by(date) %>% 
  summarise(
    across(
      all_of(vars_to_plot),
      median,
      .names = "{.col}/med"
    ),
    across(
      all_of(vars_to_plot),
      ~quantile(.x, 0.25),
      .names = "{.col}/50_l"
    ),
    across(
      all_of(vars_to_plot),
      ~quantile(.x, 0.75),
      .names = "{.col}/50_h"
    ),
    across(
      all_of(vars_to_plot),
      ~quantile(.x, 0.025),
      .names = "{.col}/95_l"
    ),
    across(
      all_of(vars_to_plot),
      ~quantile(.x, 0.975),
      .names = "{.col}/95_h"
    )
    ) %>% 
  pivot_longer(!date, names_to = "temp", values_to = "value") %>% 
  mutate(
    variable = stringr::str_split(temp, "/", n = 2),
    type = map_chr(variable, ~.x[[2]]),
    variable = map_chr(variable, ~.x[[1]])
  ) %>% 
  select(!temp) %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  mutate(
    variable = case_when(
      variable == "infections" ~ "Infections",
      variable == "hospital_demand" ~ "Hospital Bed Demand",
      variable == "ICU_demand" ~ "ICU Demand",
      variable == "new_detected_Infections" ~ "Estimated Detected Infections"
    )
  ) %>% 
  rename(ddate = date) %>% 
  filter(ddate > date - 10 & ddate <= date + 28)

ggplot(plotting_df,
       aes(x = ddate)) + 
  #geom_ribbon(aes(ymin = `95_l`, ymax = `95_h`, fill = variable), alpha = 0.25, show.legend = FALSE) + 
  geom_ribbon(aes(ymin = `50_l`, ymax = `50_h`, fill = variable), alpha = 0.25, show.legend = FALSE) +
  geom_line(aes(y = med, colour = variable), show.legend = FALSE) + 
  geom_vline(date = NULL, aes(xintercept = date), linetype = "dashed") +
  facet_wrap(vars(variable), ncol = 1, scales = "free_y",
             strip.position = "left") + 
  ggpubr::theme_pubclean() + 
  labs(x = "Date", y = "")
```

<br>



